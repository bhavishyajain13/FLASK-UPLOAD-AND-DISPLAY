import cv2
import matplotlib.pyplot as plt
from skimage import measure, morphology
from skimage.color import label2rgb
from skimage.measure import regionprops
import numpy as np

# Read the image
img = cv2.imread('temp_img_store/SIGN_CHECK.jpg', 0)
img = cv2.threshold(img, 127, 255, cv2.THRESH_BINARY)[1]

# Connected component analysis using scikit-learn framework
blobs = img > img.mean()
blobs_labels = measure.label(blobs, background=1)
image_label_overlay = label2rgb(blobs_labels, image=img)

# Initialize variables to get the biggest component
the_biggest_component = 0
total_area = 0
counter = 0
average = 0.0

# Iterate over each blob and get the highest size component
for region in regionprops(blobs_labels):
    if region.area > 10:
        total_area += region.area
        counter += 1
    if region.area >= 250:
        if region.area > the_biggest_component:
            the_biggest_component = region.area

# Calculate the average of the blob regions
average = total_area / counter

# Parameters to remove outliers of small size connected pixels
constant_parameter_1 = 60
constant_parameter_2 = 200
constant_parameter_3 = 200

# Parameter to remove outliers of large size connected pixels
constant_parameter_4 = 900

# Experimental-based ratio calculation
a4_small_size_outlier_constant = ((average / constant_parameter_1) * constant_parameter_2) + constant_parameter_3

# Experimental-based ratio calculation
a4_big_size_outlier_constant = a4_small_size_outlier_constant * constant_parameter_4

# Remove the connected pixels smaller than threshold a4_small_size_outlier_constant
pre_version = morphology.remove_small_objects(blobs_labels, a4_small_size_outlier_constant)
# Remove the connected pixels bigger than threshold a4_big_size_outlier_constant
component_sizes = np.bincount(pre_version.ravel())
too_small = component_sizes > (a4_big_size_outlier_constant)
too_small_mask = too_small[pre_version]
pre_version[too_small_mask] = 0

# Get bounding box of the largest component
for region in regionprops(pre_version):
    if region.area == the_biggest_component:
        minr, minc, maxr, maxc = region.bbox
        break

# Draw rectangle around the sign
img_with_rectangle = cv2.rectangle(image_label_overlay, (minc, minr), (maxc, maxr), (255, 0, 0), 3)

# Plot the image with rectangle
fig, ax = plt.subplots(figsize=(10, 6))
ax.imshow(img_with_rectangle)
ax.set_axis_off()
plt.tight_layout()
plt.show()

# Save the output image
plt.imsave('temp_img_store/output_with_rectangle.png', img_with_rectangle)
